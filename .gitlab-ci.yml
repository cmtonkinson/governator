stages:
  - test

variables:
  SCRIPT_DIR: "${CI_PROJECT_DIR}/scripts"

lint-and-test:
  image: python:latest
  stage: test
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends git curl ca-certificates wget shellcheck shfmt jq
    - git clone https://github.com/bats-core/bats-core.git /tmp/bats-core
    - /tmp/bats-core/install.sh /usr/local
    - pip install --no-cache-dir shell-gpt
  script:
    - |
      echo "ref_name=$CI_COMMIT_REF_NAME"
      echo "ref_protected=$CI_COMMIT_REF_PROTECTED"
      echo "pipeline_source=$CI_PIPELINE_SOURCE"
      echo "has_key=$([[ -n "${SGPT_API_KEY:-}" ]] && echo yes || echo no)"
      echo "key_len=${#SGPT_API_KEY}"
      if [[ -z "${SGPT_API_KEY:-}" ]]; then
        echo "SGPT_API_KEY is required for sgpt-backed tests"
        exit 1
      fi
      export SGPT_MODEL="${SGPT_MODEL:-gpt-4o-mini}"
      cd "$CI_PROJECT_DIR"
      ./scripts/all-tests.sh
